import logging
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup, InputMediaPhoto, InputMediaVideo
from telegram.ext import Updater, CommandHandler, CallbackQueryHandler, MessageHandler, Filters, CallbackContext
from datetime import datetime, timedelta

# Enable logging
logging.basicConfig(format='%(asctime)s - %(name)s - %(levelname)s - %(message)s', level=logging.INFO)
logger = logging.getLogger(__name__)

# Define constants
TASKS = []
MEDIA = []
RECOMMENDATIONS = {
    "movies": ["Inception", "The Matrix", "Interstellar"],
    "books": ["1984", "Brave New World", "Fahrenheit 451"],
    "music": ["Bohemian Rhapsody", "Stairway to Heaven", "Hotel California"]
}

# Start command handler
def start(update: Update, context: CallbackContext) -> None:
    keyboard = [
        [InlineKeyboardButton("Задачи", callback_data='tasks')],
        [InlineKeyboardButton("Медиа", callback_data='media')],
        [InlineKeyboardButton("Рекомендации", callback_data='recommendations')],
        [InlineKeyboardButton("Настройки", callback_data='settings')]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    update.message.reply_text('Добро пожаловать! Выберите раздел:', reply_markup=reply_markup)

# Callback query handler
def button(update: Update, context: CallbackContext) -> None:
    query = update.callback_query
    query.answer()

    if query.data == 'tasks':
        show_tasks(query)
    elif query.data == 'media':
        show_media(query)
    elif query.data == 'recommendations':
        show_recommendations(query)
    elif query.data == 'settings':
        show_settings(query)

# Show tasks
def show_tasks(query):
    keyboard = [
        [InlineKeyboardButton("Добавить задачу", callback_data='add_task')],
        [InlineKeyboardButton("Назад", callback_data='back')]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    tasks_text = "\n".join([f"{task['description']} - {task['time']} - {task['category']}" for task in TASKS])
    query.edit_message_text(text=f"Ваши задачи:\n{tasks_text}", reply_markup=reply_markup)

# Add task
def add_task(update: Update, context: CallbackContext) -> None:
    context.user_data['adding_task'] = True
    update.callback_query.edit_message_text(text="Введите описание задачи:")

# Handle text messages
def handle_text(update: Update, context: CallbackContext) -> None:
    if context.user_data.get('adding_task'):
        context.user_data['task_description'] = update.message.text
        context.user_data['adding_task'] = False
        context.user_data['adding_time'] = True
        update.message.reply_text("Введите время выполнения задачи (в формате ЧЧ:ММ):")
    elif context.user_data.get('adding_time'):
        context.user_data['task_time'] = update.message.text
        context.user_data['adding_time'] = False
        context.user_data['adding_category'] = True
        update.message.reply_text("Введите категорию задачи (Работа, Учёба, Личное):")
    elif context.user_data.get('adding_category'):
        task = {
            'description': context.user_data['task_description'],
            'time': context.user_data['task_time'],
            'category': update.message.text
        }
        TASKS.append(task)
        context.user_data['adding_category'] = False
        update.message.reply_text("Задача добавлена!")
        show_tasks(update.message)

# Show media
def show_media(query):
    keyboard = [
        [InlineKeyboardButton("Загрузить медиа", callback_data='upload_media')],
        [InlineKeyboardButton("Назад", callback_data='back')]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    media_text = "\n".join([f"{media['type']} - {media['caption']}" for media in MEDIA])
    query.edit_message_text(text=f"Ваши медиа:\n{media_text}", reply_markup=reply_markup)

# Upload media
def upload_media(update: Update, context: CallbackContext) -> None:
    context.user_data['uploading_media'] = True
    update.callback_query.edit_message_text(text="Отправьте изображение или видео:")

# Handle media messages
def handle_media(update: Update, context: CallbackContext) -> None:
    if context.user_data.get('uploading_media'):
        media = {
            'type': 'photo' if update.message.photo else 'video',
            'file_id': update.message.photo[-1].file_id if update.message.photo else update.message.video.file_id,
            'caption': update.message.caption or ''
        }
        MEDIA.append(media)
        context.user_data['uploading_media'] = False
        update.message.reply_text("Медиа загружено!")
        show_media(update.message)

# Show recommendations
def show_recommendations(query):
    keyboard = [
        [InlineKeyboardButton("Фильмы", callback_data='movies')],
        [InlineKeyboardButton("Книги", callback_data='books')],
        [InlineKeyboardButton("Музыка", callback_data='music')],
        [InlineKeyboardButton("Назад", callback_data='back')]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    query.edit_message_text(text="Выберите категорию рекомендаций:", reply_markup=reply_markup)

# Show settings
def show_settings(query):
    query.edit_message_text(text="Настройки пока недоступны.")

# Main function
def main() -> None:
    updater = Updater("YOUR_TELEGRAM_BOT_TOKEN")

    dispatcher = updater.dispatcher

    dispatcher.add_handler(CommandHandler("start", start))
    dispatcher.add_handler(CallbackQueryHandler(button))
    dispatcher.add_handler(MessageHandler(Filters.text & ~Filters.command, handle_text))
    dispatcher.add_handler(MessageHandler(Filters.photo | Filters.video, handle_media))

    updater.start_polling()
    updater.idle()

if __name__ == '__main__':
    main()
