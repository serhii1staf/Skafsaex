// Frontend: Telegram Dating App
const tg = window.Telegram.WebApp;

// Initialize the app
Telegram.WebApp.ready();
const appContainer = document.getElementById('app');

// Profile Data
let userProfile = {};
let matches = [];
let chatHistory = {};
let theme = 'light';
let notificationsEnabled = true;

// Basic UI Elements
function createUI() {
  appContainer.innerHTML = `
    <div id="registration" style="display: flex; flex-direction: column; align-items: center;">
      <h2>Welcome!</h2>
      <p>Please complete your profile:</p>
      <input type="text" id="name" placeholder="Enter your name" required />
      <input type="text" id="city" placeholder="Enter your city" required />
      <input type="file" id="photo" accept="image/*" required />
      <textarea id="description" placeholder="Describe yourself" required></textarea>
      <button id="submitProfile">Submit</button>
    </div>

    <div id="profile" style="display: none;">
      <h2>Your Profile</h2>
      <p id="profileDetails"></p>
      <button id="editProfile">Edit Profile</button>
      <button id="findMatches">Find Matches</button>
    </div>

    <div id="matches" style="display: none;">
      <h2>People Near You</h2>
      <div id="matchList"></div>
      <button id="goBack">Back</button>
    </div>

    <div id="chat" style="display: none;">
      <h2>Chat with <span id="chatWith"></span></h2>
      <div id="chatHistory"></div>
      <input type="text" id="chatMessage" placeholder="Type your message" />
      <button id="sendMessage">Send</button>
      <button id="closeChat">Close Chat</button>
    </div>

    <div id="settings" style="display: none;">
      <h2>Settings</h2>
      <div>
        <label>Theme:</label>
        <select id="themeSelector">
          <option value="light">Light</option>
          <option value="dark">Dark</option>
        </select>
      </div>
      <div>
        <label>Notifications:</label>
        <input type="checkbox" id="notificationsToggle" checked />
      </div>
      <button id="saveSettings">Save Settings</button>
      <button id="closeSettings">Close Settings</button>
    </div>

    <div id="navigation">
      <button id="homeButton">üè†</button>
      <button id="profileButton">üë§</button>
      <button id="settingsButton">‚öôÔ∏è</button>
      <button id="likeButton">‚ù§Ô∏è</button>
      <button id="boyGirlIcon">üë¶üëß</button>
    </div>
  `;
}

createUI();

// Event Listeners
const registrationForm = document.getElementById('registration');
const profilePage = document.getElementById('profile');
const matchesPage = document.getElementById('matches');
const chatPage = document.getElementById('chat');
const settingsPage = document.getElementById('settings');

const nameInput = document.getElementById('name');
const cityInput = document.getElementById('city');
const photoInput = document.getElementById('photo');
const descriptionInput = document.getElementById('description');

const submitProfileBtn = document.getElementById('submitProfile');
const editProfileBtn = document.getElementById('editProfile');
const findMatchesBtn = document.getElementById('findMatches');
const goBackBtn = document.getElementById('goBack');
const sendMessageBtn = document.getElementById('sendMessage');
const closeChatBtn = document.getElementById('closeChat');
const settingsButton = document.getElementById('settingsButton');
const saveSettingsBtn = document.getElementById('saveSettings');
const closeSettingsBtn = document.getElementById('closeSettings');
const themeSelector = document.getElementById('themeSelector');
const notificationsToggle = document.getElementById('notificationsToggle');
const boyGirlIcon = document.getElementById('boyGirlIcon');

submitProfileBtn.addEventListener('click', () => {
  const name = nameInput.value;
  const city = cityInput.value;
  const photo = photoInput.files[0];
  const description = descriptionInput.value;

  if (name && city && photo && description) {
    userProfile = { name, city, photo, description }; // In real-world, upload photo to server

    registrationForm.style.display = 'none';
    profilePage.style.display = 'flex';

    updateProfilePage();
  } else {
    alert('Please fill all fields!');
  }
});

editProfileBtn.addEventListener('click', () => {
  registrationForm.style.display = 'flex';
  profilePage.style.display = 'none';
});

findMatchesBtn.addEventListener('click', () => {
  profilePage.style.display = 'none';
  matchesPage.style.display = 'block';
  fetchMatches();
});

goBackBtn.addEventListener('click', () => {
  matchesPage.style.display = 'none';
  profilePage.style.display = 'flex';
});

sendMessageBtn.addEventListener('click', () => {
  const message = document.getElementById('chatMessage').value;
  const chatWith = document.getElementById('chatWith').textContent;

  if (message) {
    if (!chatHistory[chatWith]) {
      chatHistory[chatWith] = [];
    }
    chatHistory[chatWith].push({ sender: userProfile.name, message });
    updateChatHistory(chatWith);
    document.getElementById('chatMessage').value = '';
  }
});

closeChatBtn.addEventListener('click', () => {
  chatPage.style.display = 'none';
  matchesPage.style.display = 'block';
});

settingsButton.addEventListener('click', () => {
  settingsPage.style.display = 'block';
  profilePage.style.display = 'none';
});

saveSettingsBtn.addEventListener('click', () => {
  theme = themeSelector.value;
  notificationsEnabled = notificationsToggle.checked;
  applyTheme(theme);
  alert('Settings saved!');
});

closeSettingsBtn.addEventListener('click', () => {
  settingsPage.style.display = 'none';
  profilePage.style.display = 'flex';
});

boyGirlIcon.addEventListener('click', () => {
  if (userProfile.gender === 'male') {
    alert('Feature for boys!');
  } else if (userProfile.gender === 'female') {
    alert('Feature for girls!');
  } else {
    alert('Feature for everyone!');
  }
});

function updateProfilePage() {
  const profileDetails = document.getElementById('profileDetails');
  profileDetails.innerHTML = `
    <strong>Name:</strong> ${userProfile.name}<br>
    <strong>City:</strong> ${userProfile.city}<br>
    <strong>Description:</strong> ${userProfile.description}<br>
  `;
}

function fetchMatches() {
  // Dummy Data for Matches
  matches = [
    { name: 'Alice', city: userProfile.city, description: 'I love music and traveling' },
    { name: 'Bob', city: userProfile.city, description: 'Cooking and sports enthusiast' },
  ];

  const matchList = document.getElementById('matchList');
  matchList.innerHTML = '';

  matches.forEach((match) => {
    const matchItem = document.createElement('div');
    matchItem.style.border = '1px solid #ccc';
    matchItem.style.margin = '10px';
    matchItem.style.padding = '10px';
    matchItem.innerHTML = `
      <strong>Name:</strong> ${match.name}<br>
      <strong>City:</strong> ${match.city}<br>
      <strong>Description:</strong> ${match.description}<br>
      <button class="likeButton" data-name="${match.name}">Like</button>
    `;
    matchList.appendChild(matchItem);
  });

  document.querySelectorAll('.likeButton').forEach((btn) => {
    btn.addEventListener('click', () => {
      const likedName = btn.getAttribute('data-name');
      handleLike(likedName);
    });
  });
}

function handleLike(likedName) {
  alert(`You liked ${likedName}!`); // Extend logic to handle mutual likes
  startChat(likedName);
}

function startChat(chatWith) {
  matchesPage.style.display = 'none';
  chatPage.style.display = 'block';

  document.getElementById('chatWith').textContent = chatWith;
  updateChatHistory(chatWith);
}

function updateChatHistory(chatWith) {
  const chatHistoryDiv = document.getElementById('chatHistory');
  chatHistoryDiv.innerHTML = '';

  if (chatHistory[chatWith]) {
    chatHistory[chatWith].forEach((msg) => {
      const messageDiv = document.createElement('div');
      messageDiv.textContent = `${msg.sender}: ${msg.message}`;
      chatHistoryDiv.appendChild(messageDiv);
    });
  }
}

function applyTheme(theme) {
  if (theme === 'dark') {
    document.body.style.backgroundColor = '#333';
    document.body.style.color = '#fff';
  } else {
    document.body.style.backgroundColor = '#fff';
    document.body.style.color = '#000';
  }
}
